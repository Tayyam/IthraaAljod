<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Collection Form</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- intl-tel-input CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .form-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .iti {
            width: 100%;
        }
        .invalid-feedback {
            display: none;
            color: red;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Ithraa alkhair form</h2>
        <form id="dataForm">
            <!-- Name Field -->
            <div class="form-group">
                <label for="name">First and second name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="Enter your name" required>
            </div>

             <!-- Phone Number with Country Code -->
             <div class="form-group">
                <label for="phone">What's app Number:</label>
                <input type="tel" class="form-control" id="phone" name="phone" required>
                <div class="invalid-feedback" id="phoneError">Please enter a valid phone number.</div>
            </div>

            <!-- Email Field -->
            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email" required>
            </div>

             <!-- Nationality Dropdown (Populated from Google Sheet) -->
             <div class="form-group">
                <label for="country">Nationality</label>
                <select class="form-control" id="Nationality" name="Nationality" required>
                    <option value="" disabled selected></option>
                </select>
            </div>

            <!-- Country Dropdown (Populated from Google Sheet) -->
            <div class="form-group">
                <label for="country">Country of risidence :</label>
                <select class="form-control" id="country" name="country" required>
                    <option value="" disabled selected></option>
                </select>
            </div>

              <!-- City Dropdown (Dependent on Country) -->
              <div class="form-group">
                <label for="city">City of risidence :</label>
                <select class="form-control" id="city" name="city" required>
                    <option value="" disabled selected></option>
                </select>
            </div>

            <!-- City Dropdown (Dependent on Country) -->
            <div class="form-group">
                <label for="city">Nearest airport</label>
                <select class="form-control" id="airport" name="airport" required>
                    <option value="" disabled selected></option>
                </select>
            </div>

             <!-- Yes/No Question -->
             <div class="form-group">
                <label for="newsletter">Do you prefer to be able to change your flight ?</label>
                <select class="form-control" id="changeFlight" name="changeFlight" required>
                    <option value="" disabled selected>Choose an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>

             <!-- Yes/No Question -->
             <div class="form-group">
                <label for="Madinahdate">which option do you prefer most ?</label>
                <select class="form-control" id="Madinahdate" name="Madinahdate" required>
                    <option value="" disabled selected>Choose an option</option>
                    <option value="Yes">Madinah before hajj</option>
                    <option value="No">Madinah After hajj</option>
                </select>
            </div>

           

            <!-- Department Dropdown -->
            <div class="form-group">
                <label for="packagetype">What is your favorite package type ?</label>
                <select class="form-control" id="packagetype" name="packagetype" required>
                    <option value="" disabled selected>Select your package</option>
                    <option value="luxuary">luxuary</option>
                    <option value="luxuary shifting">luxuary shifting</option>
                    <option value="premium">premium</option>
                    <option value="premium shifting">premium shifting</option>
                    <option value="premium">standard</option>
                    <option value="premium shifting">standard shifting</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary btn-block">Submit</button>
        </form>

        <p id="responseMessage" class="text-center mt-3"></p>
    </div>

    <!-- Bootstrap JS, jQuery, and Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- intl-tel-input JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <script>
        // Initialize the intl-tel-input plugin on the phone input
        const phoneInputField = document.querySelector("#phone");
        const phoneError = document.getElementById("phoneError");
        const phoneInput = window.intlTelInput(phoneInputField, {
            preferredCountries: ["us", "uk", "sa", "eg"],
            separateDialCode: true, // Makes the country code visible and separated
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js", // To enable validation
        });

        const form = document.getElementById('dataForm');

// Function to load data from localStorage if available
function loadDataFromLocalStorage(key) {
    const storedData = localStorage.getItem(key);
    return storedData ? JSON.parse(storedData) : null;
}

// Function to save data to localStorage
function saveDataToLocalStorage(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

// Fetch country list from SheetDB and populate the dropdown without duplicates
async function fetchCountries() {
    // Load from localStorage if available
    const storedCountries = loadDataFromLocalStorage('countries');
    if (storedCountries) {
        populateDropdown(storedCountries, 'country', 'Select your country');
    }

    try {
        const response = await fetch('https://sheetdb.io/api/v1/s9fz2u8f0f9p0');
        const data = await response.json();

        // Create a Set to remove duplicates
        const uniqueCountries = Array.from(new Set(data.map(item => item.Country)));

        // Save data to localStorage
        saveDataToLocalStorage('countries', uniqueCountries);

        // Populate the dropdown
        populateDropdown(uniqueCountries, 'country', 'Select your country');
    } catch (error) {
        console.error('Error fetching country data:', error);
    }
}

// Fetch nationality list from SheetDB and populate the dropdown without duplicates
async function fetchNationalities() {
    // Load from localStorage if available
    const storedNationalities = loadDataFromLocalStorage('nationalities');
    if (storedNationalities) {
        populateDropdown(storedNationalities, 'Nationality', 'Select your nationality');
    }

    try {
        const response = await fetch('https://sheetdb.io/api/v1/s9fz2u8f0f9p0');
        const data = await response.json();

        // Create a Set to remove duplicates
        const uniqueNationalities = Array.from(new Set(data.map(item => item.Nationality)));

        // Save data to localStorage
        saveDataToLocalStorage('nationalities', uniqueNationalities);

        // Populate the dropdown
        populateDropdown(uniqueNationalities, 'Nationality', 'Select your nationality');
    } catch (error) {
        console.error('Error fetching nationality data:', error);
    }
}

// Function to populate dropdowns with options
function populateDropdown(dataArray, dropdownId, placeholder) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = `<option value="" disabled selected>${placeholder}</option>`; // Add placeholder

    dataArray.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        dropdown.appendChild(option);
    });
}

// Fetch city data based on selected country
async function fetchCities(country) {
    try {
        const response = await fetch('https://sheetdb.io/api/v1/s9fz2u8f0f9p0');
        const data = await response.json();

        const cityDropdown = document.getElementById('city');
        cityDropdown.innerHTML = '<option value="" disabled selected>Select your city</option>'; // Clear the previous options
        const filteredCities = data.filter(item => item.Country === country);

        filteredCities.forEach(item => {
            const option = document.createElement('option');
            option.value = item.City; // Assuming the column name in your sheet is 'City'
            option.textContent = item.City;
            cityDropdown.appendChild(option);
        });
    } catch (error) {
        console.error('Error fetching city data:', error);
    }
}

// Fetch nearest airports based on selected city or country
async function fetchAirports(city) {
    try {
        const response = await fetch('https://sheetdb.io/api/v1/s9fz2u8f0f9p0'); // Adjust the URL if needed
        const data = await response.json();

        const airportDropdown = document.getElementById('airport');
        airportDropdown.innerHTML = '<option value="" disabled selected>Select nearest airport</option>'; // Clear previous options

        // Filter based on city
        const filteredAirports = data.filter(item => item.City === city);

        if (filteredAirports.length === 0) {
            // Add a fallback option if no airports are available
            const noAirportOption = document.createElement('option');
            noAirportOption.value = "";
            noAirportOption.textContent = "No airports available";
            airportDropdown.appendChild(noAirportOption);
        } else {
            filteredAirports.forEach(item => {
                const option = document.createElement('option');
                option.value = item.airport; // Use lowercase 'airport' as per your data structure
                option.textContent = item.airport;
                airportDropdown.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error fetching airport data:', error);
    }
}

// On page load, fetch country and nationality data
window.onload = function() {
    fetchCountries();
    fetchNationalities();
};

// Event listener for city dropdown to update nearest airports based on the selected city
document.getElementById('city').addEventListener('change', (event) => {
    const selectedCity = event.target.value;
    fetchAirports(selectedCity);
});

// Event listener for country dropdown to update cities based on the selected country
document.getElementById('country').addEventListener('change', (event) => {
    const selectedCountry = event.target.value;
    fetchCities(selectedCountry);
});


        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevents the form from refreshing the page
            
            const formData = new FormData(form); 
            const name = formData.get('name');
            const email = formData.get('email');
            const packagetype = formData.get('packagetype');
            const country = formData.get('country'); // Get the selected country
            const nationality = formData.get('Nationality'); // Get the selected country
            const city = formData.get('city'); // Get the selected city
            const phone = phoneInput.getNumber(); // Get the full international phone number
            const isValidPhone = phoneInput.isValidNumber(); // Validate the phone number
            const changeFlight = formData.get('changeFlight');
            const Madinahdate = formData.get('Madinahdate');
            const airport = formData.get('airport');
            
            // Validate phone number before submitting
            if (!isValidPhone) {
                phoneError.style.display = "block"; // Show validation error
                return; // Stop the form from submitting
            } else {
                phoneError.style.display = "none"; // Hide validation error
            }
            
            // Send the form data to SheetDB
            const response = await fetch('https://sheetdb.io/api/v1/yprkco4u9gcxf', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    data: [
                        {
                            "Name": name,
                            "Email": email,
                            "packagetype": packagetype,
                            "Country": country,
                            "City": city,
                            "Phone": phone,
                            "changeFlight": changeFlight,
                            "Madinahdate": Madinahdate,
                            "airport": airport,
                            "Nationality" : nationality
                        }
                    ]
                })
            });

            if (response.ok) {
                document.getElementById('responseMessage').textContent = "Data submitted successfully!";
            } else {
                document.getElementById('responseMessage').textContent = "There was an error submitting your data.";
            }
        });
    </script>
</body>
</html>
